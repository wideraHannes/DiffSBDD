# Day 3: Overfit Test (1 Sample)

**Date**: December 4, 2024
**Phase**: Phase 0 - Scientific Validation
**Status**: IN PROGRESS - Data Bug Fixed, Ready to Retrain
**Time Spent**: ~4 hours

---

## Goals for Today

- [x] Create 1-sample dataset with ESM-C embedding
- [x] Create config for 1-sample overfit test
- [x] Debug data loading issues
- [ ] Train model on 1 sample (50 epochs)
- [ ] Verify training loss reaches ~0
- [ ] Verify model generates valid molecule

---

## What Was Accomplished

### 1. Found Critical Data Bug

**Problem**: Model generated 400 random atoms with 0% connectivity instead of learning the 31-atom training molecule.

**Root Cause**: The crossdock data format stores all atoms **concatenated** with a mask array:

```python
lig_coords: (265, 3)   # ALL 265 atoms from 10 samples concatenated
lig_mask:   (265,)     # Values 0-9 indicating which sample each atom belongs to
```

The original `create_1sample_dataset.py` did:

```python
data_dict[key] = f[key][:1]  # WRONG: gets 1 ATOM, not 1 SAMPLE
```

**Fix**: Use mask to extract all atoms for sample 0:

```python
mask = data['lig_mask'] == 0
lig_coords = data['lig_coords'][mask]  # Gets all 31 atoms for sample 0
```

### 2. Fixed size_distribution Format

**Problem**: `IndexError: tuple index out of range`

**Root Cause**: `size_distribution.npy` needs to be 2D (ligand_size, pocket_size) joint distribution, not 1D.

**Fix**: Create proper 2D array:

```python
size_dist = np.zeros((48, 646))
size_dist[31, 369] = 1.0  # Single sample at (lig=31, pocket=369)
```

### 3. Verified Correct Data

After fix:

- Ligand: 31 atoms (17 C, 8 N, 6 O)
- Pocket: 369 atoms
- Size distribution: 2D format (48, 646)

---

## Files

```
thesis_work/experiments/day3_overfit/
├── README.md                    # Instructions
├── create_1sample_dataset.py    # FIXED - proper mask handling
├── configs/
│   └── day3_overfit_config.yml
├── data_1sample/                # CORRECT DATA
│   ├── train.npz (31 atoms)
│   ├── val.npz
│   ├── test.npz
│   ├── size_distribution.npy (2D)
│   └── esmc_embeddings/
└── outputs/                     # Empty, ready for training
```

---

## Command to Run Tomorrow

```bash
uv run python train.py --config thesis_work/experiments/day3_overfit/configs/day3_overfit_config.yml
```

---

## Issues Encountered & Resolved

### Issue 1: Dataset Creation Bug (CRITICAL)

- **Symptom**: Generated 400 random atoms, 0% connectivity
- **Cause**: Sliced `[:1]` got 1 atom instead of using mask to get all 31 atoms
- **Fix**: Updated `create_1sample_dataset.py` to use mask properly

### Issue 2: Size Distribution Format

- **Symptom**: `IndexError: tuple index out of range`
- **Cause**: 1D array instead of required 2D joint distribution
- **Fix**: Create 2D array with single non-zero entry at (31, 369)

### Issue 3: Dimension Mismatch (from earlier)

- **Symptom**: Tensor size mismatch (14 vs 13)
- **Cause**: `dataset: "crossdock"` (10 atom types) vs data with 11 types
- **Fix**: Use `dataset: "crossdock_full"` (11 atom types including 'others')

---

## Learning Points

1. **Crossdock data format is concatenated** - must use mask to extract individual samples
2. **size_distribution is 2D** - joint distribution over (ligand_size, pocket_size)
3. **Always verify data shapes** before training

---

## Next Steps

ok we finished day 3 can you add this information to day 4 we need to overfit on 1-5 samples before continueing maybe extra
idea is to look how it behaves without esmc? that we can run the "default" training

1. Run training with fixed data
2. Check if loss decreases
3. Verify generated molecule has 31 atoms with proper connectivity
4. If successful, move to small dataset training
